---
Title: 2020wcmj-.ssh課程
Date: 2020-05-22 14:30
Category: Misc
Tags: 2020wcmj-class
Slug: 2020-wcmj-class2-Windows
Author: 50833103
---
以 SSH 維護倉儲
<!-- PELICAN_END_SUMMARY -->

觀念一:git可直接支援https,使用ssh需依賴其他工具(例如:putty)
觀念二:git倉儲的連線設定-http or ssh
觀念三:操作系統的網路協定 IPV4或IPV6
絕對觀念:github 目前只支援IPV4
將各種條件與約束編號:
git命令 使用 https(1) 使用 ssh(2)
git倉儲 使用 https(3) 使用 ssh(4)
操作系統 IPV4(5)      IPV6(6)
github                  IPV4(7)
以下為各條件所組合的使用情況,其中打X為不可行的組合
1-3-5-7

1-3-6-7

1-4-5-7 X

1-4-6-7 X

2-3-5-7 X

2-3-6-7 X

2-4-5-7

2-4-6-7

由於在電腦教室時採用純 IPv6 協定上網, 因此為了能夠在近端將倉儲改版資料推送到目前只接受 IPv4 協定連線的 github, 以下除了將原本以 https 對 github 連線, 改為以 ssh 協定連線外, 在 Windows 環境下必須利用 putty 與 plink, 設定 putty 格式的 .ppk 以及能夠同時支援 IPv4 與 IPv6 的代理主機.
設定步驟如下:

1. 下載 Putty 工具組
從 https://www.chiark.greenend.org.uk/~sgtatham/putty/ 下載一般版, 或從 http://jakub.kotrla.net/putty/ 下載特殊的可攜版本.
---

2. 利用 y:\portablegit\bin\sh.exe 進入 shell 命令環境後, 以 
ssh-keygen -t rsa -b 4096 -C "使用者學號"
在 /y/home/.ssh 目錄下建立 id_rsa 與 id_rsa.pub 等 private key 與 public key
之後以 SciTE 開啟 id_rsa.pub 後, 將此 public key 的內容, 以新增添加到 Github.com 帳號下 personal settings -> SSH and GPG keys 頁面下.
---

3. 接下來要利用 puttygen.exe 將 id_rsa 轉為 Putty 可以解讀的 .ppk 格式, 並修改隨身系統的啟動批次檔案, 指定利用 putty 目錄下的 plink 執行 git 指令的網路代理設定.
---

1 修改啟動的 start.bat 加入下列設定:

2  

3 set GIT_HOME=%Disk%:\portablegit\bin\

4 set GIT_SSH=%Disk%:\putty\plink.exe

4. 利用 puttygen.exe 載入第二步驟所建立的 private key, 也就是 id_rsa.
開啟 puttygen 之後, 以右下方的 load 載入 id_rsa, 成功載入後, 利用 save private key 按鈕, 將已經轉為 putty 格式的 .ppk 存檔. 此一 .ppk 檔案必須在設定 putty 中 github.com session 時, 在 Connection->SSH->Auth 項目下, 將轉檔後的 .ppk 指向 private key file for authentication 欄位. 
並在 Connection->Proxy 項目下, 指定 Proxy type: HTTP, 並將 IPv6 代理主機設為 ::53 或 ::42 埠號設為 3128.
---

5. 之後確定 home 下的 .ssh 目錄中的 config 設定檔案為:
---

1 # no proxy at home

2 #ProxyCommand y:/PortableGit/mingw64/bin/connect.exe -H proxy.mde.nfu.edu.tw:3128 %h %p

3 # set git_ssh=y:/putty/plink.exe with auth under putty github.com session setup

4 ProxyCommand y:/putty/plink.exe github.com %h %p

5  

6  Host github.com

7  User git

8  Port 22

9  Hostname github.com

10     

11 # for connect.exe need openssh key format

12 #IdentityFile "y:\home\.ssh\id_rsa_mdecourse"

13 # for plink.exe need rsa key format but set under putty github.com session

14 # plink.exe do not need the following setting

15 #IdentityFile "y:\home\.ssh\mdecourse_putty_private.ppk"

16 

17 TCPKeepAlive yesIdentitiesOnly yes

18 IdentitiesOnly yes

6. 最後再將 wcmj2020 倉儲中 .git 目錄下的 config 檔案中的連線協定, 由 https 改為採 ssh 連線: 範例如下:
---

1 [core]

2   repositoryformatversion = 0

3    filemode = false

4   bare = false

5 logallrefupdates = true

6  symlinks = false

7    ignorecase = true

8 [submodule]

9    active = .

10 [remote "origin"]

11    #url = https://github.com/mdecourse/wcmj2020.git

12    url = git@github.com:mdecourse/wcmj2020.git

13    fetch = +refs/heads/*:refs/remotes/origin/*

14 [branch "master"]

15    remote = origin

16    merge = refs/heads/master

17 [submodule "cmsimde"]

18    url = https://github.com/mdecourse/cmsimde.git

之後就可以透過近端的 .ppk private key 與 Github.com 上的 public key 對應, 無需輸入帳號密碼就可以進行 git push.
